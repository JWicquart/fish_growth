---
title: "Exploratory analysis and QAQC"
author : "Jeremy Wicquart"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: yes
    theme: "cosmo"
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 4
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.height = 18, fig.width = 12, message = FALSE, warning = FALSE, fig.align = "center")

```

# Defining functions and packages

```{r base}

# 1. Source functions ----

source("functions/graphical_par.R")
source("functions/theme_graph.R")
source("functions/pred_vbgf.R")

# 2. Required packages ----

library(tidyverse)
library(kableExtra)
library(formattable)
library(readxl)
library(plotly)
library(rfishbase)

# 3. Set theme_graph() as the default ggplot theme ----

theme_set(theme_graph())

# 4. Load data ----

data_complete <- read.csv("./../data/02_back-calculated-size-at-age_morat-et-al.csv")

```

# 1. Data exploration

## 1.1 Tables

### 1.1.1 Data with back-calc.

```{r}

data_complete %>% 
  filter(!is.na(Li_sp_m)) %>% 
  summarize_at(vars("ID", "Species", "Family"), n_distinct, na.rm = TRUE) %>% 
  bind_rows(data_complete %>%
              summarize_at(vars("ID", "Species", "Family"), n_distinct, na.rm = TRUE), .) %>% 
  mutate(Type = c("All data", "Back-calculated"), .before = 1) %>% 
  kable(., 
        col.names = c("", "Individual", "Species", "Family"), 
        caption = "Table 1. Comparison of numbers of individuals, species and family for the overall dataset and for back-calculated data") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

### 1.1.2 Individual by species

```{r}

data_complete %>%
  group_by(Species) %>% 
  summarise(n = length(unique(ID)),
        min_lencap = round(min(Lcpt, na.rm = TRUE), 0),
        max_lencap = round(max(Lcpt, na.rm = TRUE), 0),
        max_age = max(Agei, na.rm = TRUE)) %>% 
  kable(., 
        col.names = c("Species", "n", "Min length (TL, mm)", "Max length (TL, mm)", "Age max (years)"),
        caption = "Table 2. Number of individuals, minimum and maximum total length (mm) and maximum age, by species") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, italic = T)

```

### 1.1.3 Individuals by location

```{r}

data_complete %>%
  group_by(Species, Location) %>% 
  summarise(n = length(unique(ID))) %>% 
  pivot_wider(names_from = Location, values_from = n) %>% 
  mutate(Gambiers = cell_spec(Gambiers, "html", color = ifelse(is.na(Gambiers), "white", "#446CB3")),
         Hao = cell_spec(Hao, "html", color = ifelse(is.na(Hao), "white", "#446CB3")),
         Marquesas = cell_spec(Marquesas, "html", color = ifelse(is.na(Marquesas), "white", "#446CB3")),
         Moorea = cell_spec(Moorea, "html", color = ifelse(is.na(Moorea), "white", "#446CB3")),
         Manuae = cell_spec(Manuae, "html", color = ifelse(is.na(Manuae), "white", "#446CB3")),
         Tuamotu = cell_spec(Tuamotu, "html", color = ifelse(is.na(Tuamotu), "white", "#446CB3"))) %>% 
  kable(., 
        format = "html", escape = FALSE,
        caption = "Table 3. Number of individuals of each species by location") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, italic = T)

```

### 1.1.4 Number of NA

```{r}

# 1. Number of NA by variable

data_complete %>%
  summarise_all(~(sum(is.na(.)))) %>% 
  t(.) %>% 
  as.data.frame() %>% 
  kable(., col.names = c("NA"), caption = "Table 4. Number of rows with Non-Available (NA) data by variable") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

## 1.2 Plot

### 1.2.1 Agei *vs* Ri

```{r fig.width=15, fig.height=30, fig.cap="Figure 1. Relation between otolith radius (Ri) and age (Agei)."}

ggplot(data_complete, aes(x = Agei, y = Ri)) +
  geom_point(color = col_color_graph, fill = col_fill_graph, size = 1, shape = 21)+
  theme(strip.text.x = element_text(size = 8, face = "italic"),
        strip.background = element_rect(colour = "black", fill = col_facet, size = 1),
        plot.title = element_text(colour = col_color_graph),
        plot.subtitle = element_text(colour = "black")) +
  facet_wrap(~Species, scales = "free", ncol = 5) +
  labs(x = "Age (years)", y = "Radius (mm)")

```

### 1.2.2 Agei *vs* Li (sp.)

```{r fig.width=15, fig.height=30, fig.cap="Figure 2. Relation between length (TL, mm) and age by species."}

ggplot(data_complete, aes(x = Agei, y = Li_sp_m)) +
  geom_point(color = col_color_graph, fill = col_fill_graph, size = 1, shape = 21)+
  theme(strip.text.x = element_text(size = 8),
        strip.background = element_rect(colour = "black", fill = col_facet, size = 1),
        plot.title = element_text(colour = col_color_graph),
        plot.subtitle = element_text(colour = "black"),
        strip.text.y = element_text(angle = 360, face = "italic")) +
  facet_wrap(~Species, scales = "free", ncol = 5) +
  labs(x = "Age (years)", y = "Length (mm)")

```

### 1.2.3 Agei *vs* Li (sp. and loc.)

```{r fig.width=15, fig.height=45, fig.cap="Figure 3. Relation between length (TL, mm) and age by species and location."}

ggplot(data_complete, aes(x = Agei, y = Li_sploc_m)) +
  geom_point(color = col_color_graph, fill = col_fill_graph, size = 1, shape = 21)+
  theme(strip.text.x = element_text(size = 8),
        strip.background = element_rect(colour = "black", fill = col_facet, size = 1),
        plot.title = element_text(colour = col_color_graph),
        plot.subtitle = element_text(colour = "black"),
        strip.text.y = element_text(angle = 360, face = "italic")) +
  facet_grid(Species~Location, scales = "free") +
  labs(x = "Age (years)", y = "Length (mm)")

```

# 2. VBGF results

## 2.1 Growth parameters

```{r}

# 1. Growth parameters ----

read.csv("./../data/03_back-calculated_vbgf_predictions.csv") %>% 
  mutate(Estimate = paste0(round(Estimate, 3), " (", round(Est.Error, 3), ")")) %>% 
  pivot_wider(c("Species", Location), names_from = Parameter, values_from = Estimate) %>% 
  select(Species, Location, linf, k, t0) %>% 
  arrange(Species) %>% 
  kable(., 
        col.names = c("Species", "Location", "Linf", "K", "t0"), 
        caption = "Table 5. Values of Von Bertalanffy parameters estimated through Bayesian framework by species and location. Standard deviation are the values in parentheses. Linf is expressed in TL and cm.") %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, italic = T)

```

## 2.2 Growth curves

```{r fig.width=15, fig.height=30, fig.cap="Figure 4. Relation between length (TL, mm) and age by species and location."}

# 1. Growth curves ----

read.csv("./../data/03_back-calculated_vbgf_fitted.csv") %>% 
  ggplot(data = .) +
    geom_ribbon(aes(x = age, ymin = ypred_lq, ymax = ypred_uq, fill = Location), alpha = 0.5) +
    geom_line(aes(x = age, y = ypred_m, color = Location)) +
    geom_point(data = data_complete %>%
                 mutate(Li_sp_m = Li_sp_m/10), 
               aes(x = Agei, y = Li_sp_m, color = Location), size = 1) +
    facet_wrap(~Species, scales = "free", ncol = 5) +
    lims(y = c(0, NA)) +
    theme(strip.text.x = element_text(face = "italic")) +
    labs(x = "Age (years)", y = "Length (TL, cm)") +
    guides(colour = guide_legend(override.aes = list(alpha = 1, size = 0.5))) +
    scale_fill_manual(values = palette_location) +
    scale_color_manual(values = palette_location)

```

# 3. Raw *vs* Back-calculation

## 3.1 Growth parameters

```{r}

# 1. List of species with enough individuals for one location ----

species_list <- c("Abudefduf sexfasciatus", "Acanthurus achilles", "Acanthurus triostegus", 
                  "Chromis iomelas", "Dascyllus aruanus", "Ostorhinchus apogonoides", 
                  "Pristiapogon taeniopterus", "Stegastes nigricans")

# 1. Growth parameters ----

read.csv("./../data/03_raw_vbgf_predictions.csv") %>% 
  filter(Species %in% species_list) %>% 
  mutate(Value = paste0(round(Estimate, 3), " (", round(Est.Error, 3), ")")) %>% 
  select(Species, Location, Parameter, Value) %>% 
  pivot_wider(1:2, names_from = Parameter, values_from = Value) %>% 
  select(Species, Location, Linf, K, t0) %>% 
  arrange(Species) %>% 
  kable(., 
        col.names = c("Species", "Location", "Linf", "K", "t0"), 
        caption = "Table 5. Values of Von Bertalanffy parameters estimated through Bayesian framework by species and location. Standard deviation are the values in parentheses. Linf is expressed in TL and cm.") %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, italic = T)

```

## 3.2 Growth curves

```{r fig.width=10, fig.height=5}

# 1. Transform the data to get only Agecpt and Lcpt (-> vbgf from raw data) ----

data_raw <- read.csv("./../data/02_back-calculated-size-at-age_morat-et-al.csv") %>%
  filter(Species %in% species_list) %>% 
  select(Family, Genus, Species, ID, Agecpt, Lcpt, Location, Observer) %>% 
  unique() %>%
  dplyr::group_by(Species, Location) %>%
  dplyr::mutate(n = length(unique(ID))) %>%
  filter(n >= 10) %>% # filter with at least 10 replicates
  ungroup() %>% 
  dplyr::mutate(Lcpt = Lcpt/10) %>%  # Convert to cm
  mutate(Type = "Raw")

# 2. Transform the data (-> vbgf from back-calculated data) ----

# 2.1 Points --

data_back_calc_points <- read.csv("./../data/02_back-calculated-size-at-age_morat-et-al.csv") %>% 
  filter(Species %in% unique(data_raw$Species),
         Location %in% unique(data_raw$Location),
         !(Species == "Abudefduf sexfasciatus" & Location == "Moorea"),
         !(Species == "Acanthurus achilles" & Location == "Gambiers"),
         !(Species == "Acanthurus triostegus" & Location == "Marquesas")) %>% 
  dplyr::mutate(Li_sploc_m = Li_sploc_m/10) %>%  # Convert to cm
  mutate(Type = "Back-calculated")

# 2.2 Curves --

data_back_calc_curve <- read.csv("./../data/03_back-calculated_vbgf_fitted.csv") %>% 
  filter(Species %in% unique(data_raw$Species),
         Location %in% unique(data_raw$Location)) %>% 
  mutate(Type = "Back-calculated")

# 2. Make the plot ----

read.csv("./../data/03_raw_vbgf_fitted.csv") %>% 
  filter(Species %in% species_list) %>% 
  mutate(Type = "Raw") %>% 
  ggplot(data = .) +
    # Raw data
    geom_ribbon(aes(x = Agei, ymin = Q2.5, ymax = Q97.5, fill = Type), alpha = 0.5) +
    geom_line(aes(x = Agei, y = Estimate, color = Type)) +
    geom_point(data = data_raw, aes(x = Agecpt, y = Lcpt, color = Type), size = 1) +
    # Back-calculated data
    geom_ribbon(data = data_back_calc_curve, aes(x = age, ymin = ypred_lq, ymax = ypred_uq, fill = Type), alpha = 0.5) +
    geom_line(data = data_back_calc_curve, aes(x = age, y = ypred_m, color = Type)) +
    geom_point(data = data_back_calc_points, aes(x = Agei, y = Li_sploc_m, color = Type), size = 1) +
    # Appearance
    facet_wrap(~Species, scales = "free", ncol = 4) +
    lims(y = c(0, NA)) +
    theme(strip.text.x = element_text(face = "italic")) +
    labs(x = "Age (years)", y = "Length (TL, cm)") +
    lims(y = c(0, NA), x = c(0, NA)) +
    guides(colour = guide_legend(override.aes = list(alpha = 1, size = 0.5)))

```

# 4. Comparison with literature

```{r}

# 1. Import file synthesizing the VBGF parameters from literature ----

vbgf_literature <- read_excel("./../data/00_von-bertalanffy-literature.xlsx", sheet = 1) %>% 
  dplyr::mutate(Linf = ifelse(Size_unit == "mm", Linf/10, Linf),
                Size_max = ifelse(Size_unit == "mm", Size_max/10, Size_max)) %>% # Convert all length values to cm
  select(-Family, -Genus) # Remove Family and Genus to add those level through fishbase

# 2. Check validity of species names ----

vbgf_literature %>% 
  select(Species) %>% 
  unique() %>% 
  left_join(., load_taxa()) %>% 
  filter(is.na(Genus))

# 3. Apply the corrections and add Family and Genus ----

vbgf_literature <- vbgf_literature %>% 
  dplyr::mutate(Species = str_replace_all(Species, c("Acanthurus chirugus" = "Acanthurus chirurgus",
                                                     "Chlorurus microrbinos" = "Chlorurus microrhinos",
                                                     "Scarus psitticus" = "Scarus psittacus",
                                                     "Cetoscarus bicolour" = "Cetoscarus bicolor"))) %>% 
  left_join(., load_taxa() %>% 
                  select(Species, Genus, Family)) %>% 
  filter(Species %in% unique(data_complete$Species)) %>% 
  mutate(Reference = paste0(Reference, " (", Reference_type, ")")) %>%
  mutate_at(c("Linf", "K", "t0"), as.character) %>% 
  select(-Genus, -Family, -Size_unit, -Sex, -Reference_type) %>% 
  arrange(Species)

```

## 4.1 Growth parameters

```{r}

# 1. Comparison of VBGF parameters between our study and literature ----

read.csv("./../data/03_back-calculated_vbgf_predictions.csv") %>% 
  mutate(Estimate = paste0(round(Estimate, 3), " (", round(Est.Error, 3), ")")) %>% 
  pivot_wider(c("Species", Location), names_from = Parameter, values_from = Estimate) %>% 
  select(Species, Location, linf, k, t0) %>% 
  rename(Linf = linf, K = k) %>% 
  mutate(Reference = "This study") %>% 
  full_join(., vbgf_literature) %>%
  select(Species, Location, Linf, K, t0, Reference) %>% 
  arrange(Species) %>% 
  kable(.,
        format = "html", escape = FALSE,
        col.names = c("Species", "Location", "Linf", "K", "t0", "Reference"), 
        caption = "Table 6. Comparison between .") %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, italic = T)

```

## 4.2 Growth curves

```{r fig.height=10, fig.width=15}

# 1. Get predictions from literature data ----

vbgf_literature_pred <- vbgf_literature %>% 
  # Complete missing Age_max
  filter(is.na(Age_max)) %>% 
  left_join(., vbgf_literature %>% 
              group_by(Species) %>% 
              summarise(Age_max2 = max(Age_max, na.rm = TRUE)) %>% 
              mutate(Age_max2 = na_if(Age_max2, -Inf))) %>% 
  mutate(Age_max = ifelse(is.na(Age_max), Age_max2, Age_max)) %>% 
  select(-Age_max2) %>% 
  bind_rows(., vbgf_literature %>% 
              filter(!(is.na(Age_max)))) %>% 
  arrange(Species) %>% 
  # Fix missing t0 to 0
  dplyr::mutate(t0 = ifelse(is.na(t0), 0, t0)) %>% 
  filter(!(is.na(K)), !(is.na(Linf)), !(is.na(t0))) %>% 
  mutate_at(c("Linf", "K", "t0"), as.numeric) %>% 
  filter(Species %in% unique(read.csv("./../data/03_back-calculated_vbgf_fitted.csv")$Species)) %>% 
  # Make the predictions
  dplyr::mutate(Line = row_number()) %>% 
  group_by(Line) %>% 
  do(pred_vbgf(data = .))

# 2. Make the plot ----

plot_final <- read.csv("./../data/03_back-calculated_vbgf_fitted.csv") %>% 
  filter(Species %in% unique(vbgf_literature_pred$Species)) %>% 
  ggplot(data = .) +
  geom_ribbon(aes(x = age, ymin = ypred_lq, ymax = ypred_uq, group = Location, fill = Location), alpha = 0.5) +
  geom_line(aes(x = age, y = ypred_m, color = Location), size = 0.7) +
  geom_line(data = vbgf_literature_pred, aes(x = Agei, y = Li, group = as.factor(Line), text = Reference), size = 0.7) +
  facet_wrap(~Species, ncol = 4, scales = "free") +
  labs(x = "Age (years)", y = "Length (cm)") +
  theme(strip.text.x = element_text(face = "italic")) +
  lims(y = c(0, NA), x = c(0, NA)) +
  guides(colour = guide_legend(override.aes = list(alpha = 1, size = 0.5))) +
    scale_fill_manual(values = palette_location) +
    scale_color_manual(values = palette_location)

plot_final

```

```{r fig.height=10, fig.width=9}

# 4. Convert to plotly ----

plot_final <- plot_final +
  theme(legend.position = "none")

ggplotly(plot_final, tooltip = c("Reference", "Location", "Size_type"))

```

## 4.3 Maximum age

```{r}

# 1. Comparison of the maximum age between our study and literature ----

vbgf_literature %>% 
  filter(!(is.na(Age_max))) %>% 
  group_by(Species) %>% 
  summarise(Age_max = max(Age_max)) %>% 
  ungroup() %>% 
  left_join(., vbgf_literature) %>% 
  select(Species, Age_max, Reference) %>% 
  right_join(., data_complete %>% 
                  mutate(Lcpt = Lcpt/10) %>% 
                  filter(!(is.na(Agecpt))) %>% 
                  group_by(Species) %>% 
                  summarise(Agecpt = max(Agecpt)) %>% 
                  ungroup()) %>% 
  select(Species, Agecpt, Age_max, Reference) %>% 
  arrange(Species) %>%
  mutate(Agecpt = as.numeric(as.character(Agecpt)),
         Age_max = as.numeric(as.character(Age_max))) %>% 
  mutate(Species = cell_spec(Species, "html", color = "black"),
         Agecpt = cell_spec(Agecpt, "html", color = "black"),
         Age_max = cell_spec(Age_max, "html", color = ifelse(is.na(Age_max), "white", "black")),
         Reference = cell_spec(Reference, "html", color = ifelse(is.na(Reference), "white", "black"))) %>% 
  kable(., 
        format = "html", escape = FALSE,
        col.names = c("Species", "Age max.", "Age max.", "Reference"),
        caption = "Table 4. Comparison of maximum age (Age max.) between this study and litterature. When value of Age max. from literature is missing for one species, it can be either due to unspecified maximum age in the reference or absent value in literature for the considered species.") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  column_spec(1, italic = T) %>%
  add_header_above(c(" " = 1, "This Study" = 1, "Litterature" = 2))

```

# 5. Annex

```{r}

# 1. Variables description ----

data.frame(Column = 1:ncol(data_complete),
           Variable = colnames(data_complete),
           Description = NA,
           Unit = NA,
           Type = str_to_title(as.vector(sapply(data_complete, class)))) %>% 
  left_join(., data_complete %>% 
              mutate_if(is.character, ~NA) %>% 
              summarise_all(., ~paste0(round(min(., na.rm = TRUE), 3), " - ", round(max(., na.rm = TRUE), 3))) %>% 
              pivot_longer(everything(), names_to = "Variable", values_to = "Range") %>% 
              mutate(Range = na_if(Range, "Inf - -Inf"))) %>% 
  write.csv2(., "./../doc/03_resubmission_scientific-data/variables_description.csv", row.names = FALSE)

```

```{r}

# 1. Extract the characteristics of individual used as otoliths section examples ----

sections_example <- data_complete %>% 
  filter(ID %in% c("GAM18_B006", "AC_LI_MA_03_17_221", "AC_NI_MA_03_17_118", "AC_PY_MA_03_17_009", "MOO18FE167",
                   "GAM18_B112", "CT_MA_MA_03_17_396", "GAM18_A033", "GAM18_A059", "GAM18_B080", # Acanthuridae
                   "OS_AP_MA_03_17_284", "PR_TA_MA_03_17_101", # Apogonidae
                   "OD_NI_MA_03_17_045", "BA_UN_MO_03_16_003", # Balistidae
                   "GAM18_A100", # Chaetodontidae
                   "GAM18_A156", "SA_MI_MA_03_17_128", # Holocentridae
                   "GAM18_B066", "GAM18_A011", "GAM18_A214", # Labridae
                   "GAM18_B105", "GAM18_B093", # Lethrinidae
                   "LU_GI_MA_03_17_058", "GAM18_B099", # Lutjanidae
                   "GAM18_B129", # Mullidae
                   "GAM18_A135", "CE_BI_MO_03_16_002", "GAM18_B056", "GAM18_A162", "DA_AR_MO_03_16_011",
                   "GAM18_A036", "GAM18_A191", "CH_JO_MO_03_16_013", # Pomacentridae
                   "GAM18_A120", "SC_PS_TA_03_16_019", # Scaridae
                   "GAM18_B012", # Scombridae
                   "GAM18_A073", "GAM18_A089", "EP_FA_MA_03_17_027", "H33", "GAM18_A154", "H70", "GAM18_B052", # Serranidae
                   "GAM18_B019", "SI_SP_MO_03_16_008")) %>% # Siganidae
  filter(Agei == 0) %>% 
  select(Family, Species, ID, Agecpt, Lcpt, Location) %>% 
  arrange(Family, Species) %>% 
  mutate(Legend = paste0(row_number(), ". ", Species, " (", Agecpt, " years, ", Lcpt, " mm TL)"))

# 2. Export the txt file needed for the legend of the figure on otoliths sections ----

write.table(paste(sections_example$Legend, collapse = ", "), 
            "./../doc/03_resubmission_scientific-data/legend_fig_otolith_sections.txt", 
            col.names = FALSE, row.names = FALSE)

```

# Reproducibility

```{r reprod}

# 1. Reproducibility ----

sessionInfo()

```

---
Jeremy WICQUART | jeremywicquart@gmail.com | `r format(Sys.time())`